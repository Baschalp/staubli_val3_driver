<?xml version="1.0" encoding="utf-8"?>
<Programs xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.staubli.com/robotics/VAL3/Program/2">
  <Program name="motionControl" access="public">
    <Locals>
      <Local name="l_mTrajPt" type="MotionBuffer" xsi:type="array" size="1" />
      <Local name="l_bFlag" type="bool" xsi:type="array" size="1" />
      <Local name="l_motion" type="MotionBuffer" xsi:type="array" size="1" />
    </Locals>
    <Code><![CDATA[begin
  while (true)
    // check connection status, and whether to stop motion
    if (nDataIn == 1 and nDataOut == 1 and bStopNow == false)
      
      // process trajectory point from trajectory buffer
      if (libTrajPtBuffer:nElems > 4)
        call libTrajPtBuffer:pop(l_mTrajPt, l_bFlag)
        if (l_bFlag)
          nPtsPopped = nPtsPopped + 1
        endIf
      endIf
      
      // process motion command from move buffer
      // move buffer should have elements previously interpolated
      // to ensure they are 4 ms apart
      if (libMoveBuffer:nElems > 0)
        call libMoveBuffer:pop(l_motion, l_bFlag)
        if (l_bFlag)
          nMoveId = movej(l_motion.jJointRx, tTool, l_motion.mDesc)
          // if this is the last motion command, call waitEndMove()
          // to ensure point is reached
          if (libMoveBuffer:nElems == 0)
            waitEndMove()
          endIf
        endIf
      endIf
    else
      // stop immediately -- resetMotion() also resets moveId
      resetMotion()
      // clear buffers
      call libTrajPtBuffer:clear()
      call libMoveBuffer:clear()
      bStopNow = false
      // debug
      nPtsPopped = 0
    endIf
    
    // sequence task
    delay(0)
  endWhile
end]]></Code>
  </Program>
</Programs>